name: Whale Alert Bot v5.2

on:
  workflow_dispatch:        # manual or immediate trigger
  schedule:
    - cron: '*/5 * * * *'  # automatic every 5 minutes

jobs:
  run-bot:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        attempt: [1, 2, 3]
    timeout-minutes: 10   # prevent overlapping runs

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Whale Bot with Telegram Logging
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.CHAT_ID }}
          MIN_USD: ${{ secrets.MIN_USD }}
        run: |
          source venv/bin/activate
          ATTEMPT=${{ matrix.attempt }}
          TIMESTAMP=$(date)
          echo "Attempt $ATTEMPT running at $TIMESTAMP"
          
          python whale_bot.py && \
          python - <<EOF
import os, requests
token = os.getenv('TELEGRAM_BOT_TOKEN')
chat_id = os.getenv('TELEGRAM_CHAT_ID')
message = f"✅ Whale Bot v5.2 succeeded on attempt {ATTEMPT} at {TIMESTAMP}"
requests.post(f"https://api.telegram.org/bot{token}/sendMessage", data={"chat_id": chat_id, "text": message})
EOF
          
          # if bot fails, send failure message
          if [ $? -ne 0 ]; then
            python - <<EOF
import os, requests
token = os.getenv('TELEGRAM_BOT_TOKEN')
chat_id = os.getenv('TELEGRAM_CHAT_ID')
message = f"⚠ Whale Bot v5.2 failed on attempt {ATTEMPT} at {TIMESTAMP}"
requests.post(f"https://api.telegram.org/bot{token}/sendMessage", data={"chat_id": chat_id, "text": message})
EOF
          fi
